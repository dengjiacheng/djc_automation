<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>automation-server 新架构说明</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="app.js" defer></script>
  </head>
  <body>
    <header class="page-header">
      <h1>automation-server 新架构说明</h1>
      <p class="subtitle">分层清晰 · 模块解耦 · 面向扩展</p>
    </header>

    <main>
      <section class="summary">
        <h2>重构概览</h2>
        <p>
          本次重构将原先散落在 <code>app/api</code>、<code>app/domain</code>、<code>app/websocket</code>
          目录中的逻辑重新整合为「接口层」「业务模块层」「基础设施层」三大部分：
          <strong>app/interfaces</strong> 承载 HTTP / WebSocket 适配器，<strong>app/modules</strong>
          封装领域服务与用例，<strong>app/infrastructure</strong> 专注于数据库等技术细节。
          通过调整依赖方向，接口层只依赖模块层，模块层依赖基础设施层，实现了清晰的洋葱式结构。
        </p>
        <p>
          automation-app 依旧经由 WebSocket 与服务器的 <code>app.interfaces.ws</code> 层通信，
          所有指令、能力上报、脚本执行进度都由新的模块层统一协调，确保协议兼容与行为一致。
        </p>
      </section>

      <section class="diagram-section">
        <h2>目标架构分层</h2>
        <div class="diagram">
          <div class="layer layer-interfaces">
            <h3>Interfaces 接口层</h3>
            <ul>
              <li><code>app/interfaces/http</code> - REST &amp; 模板路由</li>
              <li><code>app/interfaces/ws</code> - 设备 / Web WebSocket</li>
            </ul>
          </div>
          <div class="layer layer-modules">
            <h3>Modules 业务模块层</h3>
            <p>账户 · 设备 · 指令 · 脚本任务 · 钱包 · 模板 · 充值 · 日志</p>
          </div>
          <div class="layer layer-infra">
            <h3>Infrastructure 基础设施</h3>
            <ul>
              <li><code>app/infrastructure/database</code> - SQLAlchemy 引擎与仓储实现</li>
              <li><code>app/services/test_apk.py</code> - APK 存储与校验</li>
            </ul>
          </div>
          <div class="layer layer-core">
            <h3>Core &amp; Shared</h3>
            <ul>
              <li><code>app/core</code> - 配置、容器、认证</li>
              <li><code>app/schemas</code> - Pydantic Schema</li>
              <li><code>app/db</code> - 兼容性入口</li>
            </ul>
          </div>
        </div>
      </section>

      <section class="modules">
        <h2>模块清单与职责</h2>
        <p>点击卡片查看详细说明，按钮可折叠 / 展开。</p>
        <div class="module-grid">
          <article class="module-card" data-target="module-accounts">
            <h3>accounts</h3>
            <p>账号认证、角色管理、密码策略</p>
            <button type="button">查看详情</button>
          </article>
          <article class="module-card" data-target="module-devices">
            <h3>devices</h3>
            <p>设备注册、在线状态、归属校验</p>
            <button type="button">查看详情</button>
          </article>
          <article class="module-card" data-target="module-commands">
            <h3>commands</h3>
            <p>指令生产、派发、结果回写</p>
            <button type="button">查看详情</button>
          </article>
          <article class="module-card" data-target="module-script-jobs">
            <h3>script_jobs</h3>
            <p>脚本分发、目标状态跟踪、批量结果汇总</p>
            <button type="button">查看详情</button>
          </article>
          <article class="module-card" data-target="module-templates">
            <h3>templates</h3>
            <p>脚本模板版本化、参数一致性校验</p>
            <button type="button">查看详情</button>
          </article>
          <article class="module-card" data-target="module-wallets">
            <h3>wallets</h3>
            <p>钱包余额、冻结 / 扣费 / 退款流水</p>
            <button type="button">查看详情</button>
          </article>
          <article class="module-card" data-target="module-topups">
            <h3>topups</h3>
            <p>充值订单、审核流程、对账</p>
            <button type="button">查看详情</button>
          </article>
          <article class="module-card" data-target="module-logs">
            <h3>logs</h3>
            <p>设备日志、进度上报、场景调试记录</p>
            <button type="button">查看详情</button>
          </article>
        </div>

        <div class="module-detail" id="module-accounts">
          <h3>accounts</h3>
          <ul>
            <li>集中在 <code>app/modules/accounts</code>，对外只暴露 <code>AccountService</code>。</li>
            <li>封装密码哈希、角色验证、最后登录时间更新等策略。</li>
            <li>SQL 仓储实现统一放在 <code>app/infrastructure/database/repositories/account_repository.py</code>。</li>
          </ul>
        </div>

        <div class="module-detail" id="module-devices">
          <h3>devices</h3>
          <ul>
            <li>负责设备注册、上线校验、离线标记。</li>
            <li>与 WebSocket 层协同，保障同一账号的设备绑定关系。</li>
            <li>提供聚合查询（列表、管理员视角、按用户名聚合）。</li>
          </ul>
        </div>

        <div class="module-detail" id="module-commands">
          <h3>commands</h3>
          <ul>
            <li>统一封装指令创建、排队、状态迁移。</li>
            <li>与 <code>ConnectionManager</code> 解耦，WebSocket 只调用服务接口。</li>
            <li>修复了历史上未向 <code>ScriptJobService</code> 传递引用导致的 NameError。</li>
          </ul>
        </div>

        <div class="module-detail" id="module-script-jobs">
          <h3>script_jobs</h3>
          <ul>
            <li>将批量脚本执行的分发、目标追踪、状态结算全部集中。</li>
            <li>对接钱包模块，实现成功扣费与失败退款。</li>
            <li>提供管理员查询、用户重试等用例。</li>
          </ul>
        </div>

        <div class="module-detail" id="module-templates">
          <h3>templates</h3>
          <ul>
            <li>存储脚本模板 JSON Schema、默认参数、历史版本。</li>
            <li>拉齐在线设备上报的 schema hash，维护兼容状态。</li>
          </ul>
        </div>

        <div class="module-detail" id="module-wallets">
          <h3>wallets</h3>
          <ul>
            <li>管理余额、交易流水、冻结 / Capture / Refund 资金流。</li>
            <li>暴露 <code>ensure_wallet</code>、<code>credit_amount</code> 等高阶接口供其它模块复用。</li>
          </ul>
        </div>

        <div class="module-detail" id="module-topups">
          <h3>topups</h3>
          <ul>
            <li>处理充值订单生命周期与管理员审核。</li>
            <li>提供列表、过滤、状态流转等接口。</li>
          </ul>
        </div>

        <div class="module-detail" id="module-logs">
          <h3>logs</h3>
          <ul>
            <li>统一写入设备日志、业务事件、脚本进度。</li>
            <li>为客户与管理员查询提供分页能力。</li>
          </ul>
        </div>
      </section>

      <section class="comparison">
        <h2>重构前后对比</h2>
        <table>
          <thead>
            <tr>
              <th>维度</th>
              <th>重构前</th>
              <th>重构后</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>目录结构</td>
              <td>API、WebSocket、Domain 分散，层次不清晰</td>
              <td>接口 / 模块 / 基础设施分层，依赖方向单向</td>
            </tr>
            <tr>
              <td>模块边界</td>
              <td>服务类和仓储分布在多处，存在循环依赖风险</td>
              <td>业务模块自包含，仓储由基础设施实现，接口依赖注入</td>
            </tr>
            <tr>
              <td>缺陷修复</td>
              <td>WebSocket 结果回调缺少 <code>job_service</code>，管理员钱包接口缺少导入</td>
              <td>补全依赖传递与导入，运行期不再抛出 NameError / ReferenceError</td>
            </tr>
            <tr>
              <td>自动化协同</td>
              <td>能力上报 / 指令分发散落在多处</td>
              <td>由 <code>app.interfaces.ws</code> 负责协商，模块层聚合业务逻辑</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section class="extensibility">
        <h2>性能与可扩展性设计</h2>
        <ul>
          <li>
            WebSocket ConnectionManager 独立模块化，便于后续接入 Redis Pub/Sub 或多进程广播；
            心跳监控改为可配置的 <code>timeout</code> 与 <code>check_interval</code>。
          </li>
          <li>
            模块层服务只依赖抽象仓储，未来可无缝接入缓存、CQRS 甚至拆分微服务。
          </li>
          <li>
            APK 仓储保持独立，结合 <code>AutomationBundle</code> 可支持版本灰度或 CDN 分发。
          </li>
          <li>
            schema hash 校验放入模块层，确保 automation-app 能力调整后服务端立即察觉并提示用户更新模板。
          </li>
          <li>
            统一使用 Pydantic Schema，接口层只负责校验与展示，降低重复解析成本。
          </li>
        </ul>
      </section>
    </main>

    <footer class="page-footer">
      <p>最后更新：<span id="build-time"></span></p>
      <p>Automation Platform · 服务器与设备保持协议兼容。</p>
    </footer>
  </body>
</html>
